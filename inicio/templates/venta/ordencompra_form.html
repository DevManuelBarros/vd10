{% extends '../base.html' %}
{% load static %}

{%  block cuerpo %}

<div class="app-page-title">
<div class="page-title-heading">
   <div class="page-title-icon">
                                        <i class="pe-7s-magic-wand icon-gradient bg-mixed-hopes">
                                        </i>
                                    </div>
<div>Crear Orden de Compra</div>
                                     
                                    </div>
</div>
<div class="main-card mb-3 card">
<div class="card-body">
<h5 class="card-title">Formulario de Orden de Compra</h5>
    <form class="needs-validation" action="" method="post">{% csrf_token %}
    <div class="form-row">
    	<div class="col-md-4 mb-3">
        {{ form.referencia_externa.label_tag }}
        {{ form.referencia_externa}}
        </div>
		<div class="col-md-4 mb-3">	
        {{ form.cliente.label_tag }}
        {{ form.cliente}}
		</div>
	</div>
	<div class="form-row">
		<div class="col-md-4 mb-3">	
        {{ form.cronograma.label_tag }}
        {{ form.cronograma }}
		</div>
		<div class="col-md-4 mb-3">
		{{ form.fecha_emision.label_tag }}
		{{ form.fecha_emision }}
		</div>    
	</div>

	<h5 class="card-title">Detalle Orden de compra</h5>
	
        <table class="mb-0 table table-hover">
            {{ ordendecompramain.management_form }}

            {% for form in ordendecompramain.forms %}
                {% if forloop.first %}
                    <thead>
                    <tr>
                        {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                {% endif %}

                <tr class="{% cycle "row1" "row2" %} formset_row">
                    {% for field in form.visible_fields %}
                        <td>
                            {# Include the hidden fields in the form #}
                            {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            {% endif %}
                            {{ field.errors.as_ul }}
                            {{ field }}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
        
        <input type="submit" value="Guardar" class="mb-2 mr-2 btn btn-primary"/> <a href="{% url 'venta:CronogramaList' %}">Volver al listado</a>
     </form>
    </div>
	</div>   
  
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="{% static 'formset/jquery.formset.js' %}"></script>
<script type="text/javascript">
    $('.formset_row').formset({
        addText: 'Agregar Linea',
        deleteText: 'Eliminar',
        prefix: 'productolineasoc_set',
		instancia : 'ordencompra'
    });
	$(document).ready(function() {
            $("#id_cliente").on("change", getCronograma);
        });

	
	 function getCronograma(valor) {
            var clienteId = $("#id_cliente").val();
            if (clienteId) {
				if(valor=='[object Object]'){
				$("#id_cronograma").html("");
				                // Eliminamos las opciones anteriores del select
				$("select[id^='id_productolineasoc_set']").each(function(index){
				$(this).html("");
				});
				}
				else
				{
				$("select#id_productolineasoc_set-" + valor + "-producto").html("");
				}

			    var request = $.ajax({
                    type: "GET",
                    url: "{% url 'venta:get_cronogramas' %}",
                    data: {
                        "id_cliente": clienteId,
                    },
                });

                request.done(function(response) {
                    // Agregamos los resultados al select
				if(valor=='[object Object]'){		
					$("#id_cronograma").html(response.cronogramas);
					$("select[id^='id_productolineasoc_set']").each(function(index){
						$(this).html(response.productos);
					 
					});
					$("#id_cronograma").trigger("change", [false]);
					 
					}else
					{
						//alert("select#id_productolineasoc_set-" + valor + "-producto");
					$("select#id_productolineasoc_set-" + valor + "-producto").html(response.productos);

					}
                 
                });
            } else {
				if(valor=='[object Object]'){
                $("#id_cronograma").html("<option value='' selected='selected'>---------</option>");
                $("#id_cronograma").trigger("change", [false]);
};
            }
	}
	
</script>
{% endblock %}